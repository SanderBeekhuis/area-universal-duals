%!TEX root = ../thesis.tex

\section{Top Fan flips}
\label{s:fanflip}

The second stage of the algorithm will consist of flipping most large topfans. The first stage of the algorithm finished by computing a vertically one-sided \rel (Lemma's \ref{lm:sweep:REL} and \ref{lm:sweep:vertOnsided}) that never has two splits below each other (Lemma \ref{lm:sweep:NoTwoSplitsAboveEachOther})

Using some local recolorings (\emph{flips}) on the topfans we will maintain a onesided REL (Lemma \ref{lm:topfan:oneSidedREL}) and make sure that large topfans only occr in very specific situations (Lemma \ref{lm:topfan:remainingTopfans}).

Our flips differ depending on whether we we encounter a split and or merge in the bottom boundary path. Refer to Figure \ref{fig:fanflip:fanflips} for the different kinds of topfanflips.


\begin{figure}
    \centering
    \begin{subfigure}[b]{0.8 \textwidth}
        \includegraphics[width = \textwidth]{topFanFlips/img/regular}
        \caption{The regular topfanflip}
        \label{fig:fanflip:regular}
    \end{subfigure}
    ~
    \centering
    \begin{subfigure}[b]{0.45 \textwidth}
        \includegraphics[width = \textwidth]{topFanFlips/img/merge}
        \caption{Topfanflip above a merge}
        \label{fig:fanflip:merge}

    \end{subfigure}
    ~
    \begin{subfigure}[b]{0.45 \textwidth}
        \includegraphics[width =\textwidth]{topFanFlips/img/mergeend}
        \caption{Topfanflip next to merge. Note the additional red edge.}
        \label{fig:fanflip:mergeLastVertex}

    \end{subfigure}
    \centering
    \begin{subfigure}[b]{0.45 \textwidth}
        \includegraphics[width = \textwidth]{topFanFlips/img/split}
        \caption{Above a split we stop}
        \label{fig:fanflip:split}

    \end{subfigure}
    ~
    \begin{subfigure}[b]{0.45 \textwidth}
        \includegraphics[width =\textwidth]{topFanFlips/img/splitfront}
        \caption{If the split is on the first vertex we don't flip at all}
        \label{fig:fanflip:splitFirstVertex}

    \end{subfigure}

    \caption{}
    \label{fig:fanflip:fanflips}
\end{figure}


\fxnote{We could make structure of the fence below the topfan more explicit. }

%When we encounter a topfan we start flipping edges. In principle we want to color all edges in the fan blue except for the right outer edge. In order to maintain a \rel we then recolor all of the rim except for the right outer edge to be red. Then we also need to to color the left outer edges of all topfans below this topfan blue. Note that all rim vertices are topfan handles since otherwise we would have a separating 4-cycle.

We consider all faces we have in order from first created to last created. We make a distinction between \emph{south-adjacent topfans} that don't have a rim vertex adjecent to $\pS$ and \emph{regular} topfans that don't have such a vertex.

\paragraph{Regular topfans}
A topfan is above a number of edges of the bottom fence. These edges are the rim of the fan.  Along this fan we can't have a merge followed by a split (Lemma \ref{lm:uni:noTfan above whole path}).

This means the rim of a fan can have a number of merges followed by a number of splits.

If the rim has no merges or splits we execute the topfanflip depicted in Figure \ref{fig:fanflip:regular}. We color all but the rightmost fan edge blue, color all but the rightmost rim edge red. And color the left sides of all topfans below this topfan in the face below the current face blue.

If the rim consists of only merges we can easily adept a topfanflip to this situation. We simply don't flip the edge merging in as depicted in Figure \ref{fig:fanflip:merge}.

A special case is given by a merge on the last vertex on the bottom edges of the top fan. In that case we flip all rim edges (even the last one) to prevent a blue $Z$ from forming. See figure \ref{fig:fanflip:mergeLastVertex}.

Splits are more difficult to handle. We are unfortunatly unable to keep flipping once we hit a split hence we stop before we get that far. See Figure \ref{fig:fanflip:split}. It this happens on the first vefrtex we don't flip at all, see Figure \ref{fig:fanflip:splitFirstVertex}.

\paragraph{South-adjacent topfans}
We call a topfan south-adjecent if any of it's rim vertices is next to the south pole.

At most two vertices of a top fan can be adjacent to the south pole. And in this case these vertices must be adjacent. Otherwise we have a separating 4-cycle.

Before the south pole we can have a split followed by a merge followed by the south pole adjacent vertices followed again by possibly splits and merges.

Fortunately we can treat this complicated faces just like any split fan. Where we stop flipping before the first split or $\pS$-adjacent vertex.

\fxnote{We might add a figure}

\paragraph{The result}
Before the topfanflips we had a vertically one-sided REL. Afterwards we still have a vertically one-sided \rel as we will prove in Lemma \ref{lm:topfan:oneSidedREL}. Moreover we have no large top-fans except for some controlled cases as we will prove in Lemma \ref{lm:topfan:remainingTopfans}.

\begin{lemma}
  \label{lm:topfan:oneSidedREL}
  If the graph was onesided before a topfanflip it is still onesided after such a flip in the regular and merge cases.
\end{lemma}
\begin{proof}
  We invite the reader to take another look at Figure \ref{fig:fanflip:fanflips}.
  Let us first consider the regular case. Since the edge  $v_n w_m$ is red (otherwise we would have a merge) this change doesn't produce any blue $Z$'s.

  Let us also consider the other merge cases. Due to the clever recoloring these also don't lead to a merge.
  %However they can lead to a face starting with a large topfan. We will later see this is a controlled topfan.

  It is clear the split cases also don't produce a blue $Z$.

  Since any south-adjecnt fan is treated like a split fan we also don't create $Z$'s  in these cases.
  %But the topfans are again controlled. As we will see in the next section.
\end{proof}


\begin{lemma}
  \label{lm:topfan:remainingTopfans}
  In the remaining faces every large topfan is in one of the following two situations.
  \begin{enumerate}
    \item  This topfan is at the start of the face
    \item  This topfan is in the midlle of the face and it's left outer rim vertex is a split.
  \end{enumerate}
\end{lemma}
\begin{proof}
  All topfans are manipulated in such a way that they start a new face unless the left outer rim vertex is a split. In that case we don't flip at all.
\end{proof}
